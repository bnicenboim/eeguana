---
title: "Artifact detection and rejection"
author: "Bruno Nicenboim"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{Artifact detection and rejection}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(width = 80)
```

This vignette demonstrates how to detect artifacts in EEG data using the `eeguana` package. To illustrate the process effectively, we first simulate synthetic artifacts. Then, we explore the relevant functions provided by `eeguana` for artifact detection, offering insights into their differences and applications.

## Setup

Initial preparation involves loading necessary libraries and setting global options and ensuring consistent results across sessions:

```{r, message = FALSE}
library(eeguana)
library(gsignal) # A new alternative to signal
library(tidytable) # A new and fast alternative to dplyr/tidyr
library(ggplot2)
# Apply EEG-specific theme settings
theme_set(theme_eeguana() + theme(legend.position = "bottom"))
set.seed(123)
```

## Simulating Synthetic Artifacts

First, we simulate common EEG artifacts: eye blinks, horizontal eye movements, and signal drift, to demonstrate artifact detection techniques.



### Eye Blinks

Eye blink simulation, inspired by a solution on [Stack Overflow](https://stackoverflow.com/questions/53071709/remove-eye-blinks-from-eeg-signal-with-ica), demonstrates typical artifacts in EEG data.


```{r}
N_samples <- 2000
fs <- 200  # Define the sampling frequency

# Simulating blinks at specific samples
blinks <- rep(0, N_samples)
blinks[c(500, 1200)] <- 1
blinks <- butter(2, c(1*2/fs, 10*2/fs), type='pass') |>
  gsignal::filter(blinks) * 2000
# Applying a median filter for smoothing
median_filter <- function(x, window_size) {
  sapply(1:length(x), function(i) {
    start <- max(1, i - (window_size %/% 2))
    end <- min(length(x), i + (window_size %/% 2))
    median(x[start:end])
  })
}
blinks <- median_filter(blinks, 20)

# Visualizing simulated eye blinks
ggplot(data.frame(x = 1:N_samples, y = blinks), aes(x, y)) +
  geom_line() +
  ggtitle("Simulated Eye Blinks")
```



### Horizontal Eye Movements

Simulating horizontal eye movements as step changes in the signal to represent another common artifact type.

```{r}
eyemov <- rep(0, N_samples)
eyemov[200:300] <- 30  # Simulate a movement artifact
```
### Signal Drift

Simulating slow voltage changes over time (signal drift)

```{r}
drift <- sin(.1 * seq.int(N_samples) / fs) * 30
```

### Pink noise

Simulating pink noise to simulate more complex signal characteristics.


```{r}
noise <- rpink(N_samples, 100) * 0.5
```


## Creating `eeg_lst` Objects

Constructing `eeg_lst` objects with simulated signals to mimic real EEG data with artifacts.

```{r}
data_with_blinks <- eeg_lst(signal_tbl = tidytable(
    Fz = as_channel_dbl(blinks + noise + drift),
    .id = 1,
    .sample = sample_int(seq.int(1, N_samples), .sampling_rate = fs)
  ))
```

```{r}
data_with_drift <- eeg_lst(signal_tbl = tidytable(
    Fz = as_channel_dbl(noise + drift * 3),
    .id = 1,
    .sample = sample_int(seq.int(1, N_samples), .sampling_rate = fs)
  ))
```


```{r}
data_with_eye_movements <- eeg_lst(signal_tbl = tidytable(
    Fz = as_channel_dbl(eyemov + noise),
    .id = 1,
    .sample = sample_int(seq.int(1, N_samples), .sampling_rate = fs)
  ))
```



## Artifact Detection

### Blinks

Chapter 6 of @Luck2014 discusses a method  known as the moving window peak-to-peak amplitude method, which is effective for distinguishing epochs with and without blinks. This method is insensitive to the overall voltage offset and slow voltage drifts, making it ideal for EEG artifact detection. It is implemented in `eeguana` as
`eeg_artif_minmax()`. 

```{r}
data_with_blinks <- data_with_blinks |>
  eeg_artif_minmax(.threshold = 75)
```

The artifacts get annotated in the events table:
```{r}
data_with_blinks
```

Visualizing detected eye blinks:
```
plot(data_with_blinks) +
  annotate_events() +
  coord_cartesian(ylim = c(-70, 40)) +
  ggtitle("Detected Eye Blinks")
```

### Drift

EEG data with only drift should not be marked as an artifact, demonstrating the method's sensitivity to genuine physiological artifacts versus normal signal variations.


```{r}
data_with_drift <- data_with_drift |>
  eeg_artif_minmax(.threshold = 75)

# Visualizing
plot(data_with_drift) +
  annotate_events() +
    coord_cartesian(ylim =c(-70,100))
```

`eeg_artif_peak()` and `eeg_artif_amplitude()` are not recommended here. The first one will look at anything that looks like peak in a certain window and exceeds some absolute threshold and amplitud will detect anything that goes beyond a certain threshold. This functions can be useful once the signal is filtered for low frequencies and/or baselined, and when used with relatively large thresholds.

```{r}
data_with_drift <- data_with_drift |>
  eeg_artif_peak(.threshold = 75) |>
  eeg_artif_amplitude(.threshold = c(-75,75))

# Visualize
plot(data_with_drift) +
  annotate_events() +
    coord_cartesian(ylim =c(-70,100))
```



### Eye movements

Chapter 6 of @Luck2014 also describes a method for detecting eye movements, emphasizing their dipole nature and the efficacy of a step function algorithm for artifact detection. This method computes the difference in mean amplitude between two halves of a window, effectively identifying changes in amplitude indicative of eye movements.

```{r}
data_with_eye_movements <- data_with_eye_movements |>
  eeg_artif_step(.threshold = 20)

plot(data_with_eye_movements) +
  annotate_events() +
    coord_cartesian(ylim =c(-70,100))
```


## References
